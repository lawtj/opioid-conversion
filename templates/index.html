<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opioid Conversion Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-base-200 min-h-screen">
    <div class="container mx-auto px-4 py-8" x-data="opioidConverter()">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-primary mb-2">Opioid Conversion Calculator</h1>
            <p class="text-base-content/70">Convert opioid medications using natural language or voice input</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Section -->
            <div class="card bg-base-100 shadow-lg">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">
                        <i class="fas fa-pills text-primary"></i>
                        Input Opioid Regimen
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Voice/Text Input -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Describe the opioid regimen</span>
                            </label>
                            <div class="relative">
                                <textarea 
                                    x-model="regimenText"
                                    class="textarea textarea-bordered w-full h-32 pr-12" 
                                    placeholder="e.g., Patient takes 30mg oxycodone twice daily and 50mcg fentanyl patch"
                                    required></textarea>
                                <button 
                                    type="button" 
                                    @click="toggleVoiceRecording()"
                                    :class="voiceStatus.recording ? 'btn btn-circle btn-error absolute right-2 top-2' : 'btn btn-circle btn-primary absolute right-2 top-2'"
                                    title="Click to record voice input">
                                    <i :class="voiceStatus.recording ? 'fas fa-stop' : 'fas fa-microphone'"></i>
                                </button>
                            </div>
                            <div x-show="voiceStatus.message" class="label">
                                <span class="label-text-alt" :class="voiceStatus.error ? 'text-error' : 'text-info'" x-text="voiceStatus.message"></span>
                            </div>
                        </div>

                        <!-- Target Drug Selection -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Target drug for conversion</span>
                            </label>
                            <select x-model="targetDrug" class="select select-bordered w-full" required>
                                <option value="morphine">Morphine</option>
                                <option value="oxycodone">Oxycodone</option>
                                <option value="hydromorphone">Hydromorphone</option>
                                <option value="fentanyl">Fentanyl</option>
                                <option value="methadone">Methadone</option>
                                <option value="buprenorphine">Buprenorphine</option>
                                <option value="tramadol">Tramadol</option>
                            </select>
                        </div>

                        <!-- Target Route Selection -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Target route</span>
                            </label>
                            <select x-model="targetRoute" class="select select-bordered w-full">
                                <option value="po">Oral (PO)</option>
                                <option value="iv">Intravenous (IV)</option>
                                <option value="im">Intramuscular (IM)</option>
                                <option value="sc">Subcutaneous (SC)</option>
                                <option value="transdermal">Transdermal</option>
                                <option value="buc_sublingual">Buccal/Sublingual</option>
                                <option value="rectal">Rectal</option>
                            </select>
                        </div>

                        <!-- Submit Button -->
                        <button 
                            @click="calculateConversion()"
                            :disabled="loading || !regimenText.trim()"
                            class="btn btn-primary btn-lg w-full">
                            <i class="fas fa-calculator"></i>
                            Calculate Conversion
                            <span x-show="loading" class="loading loading-spinner loading-sm"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="card bg-base-100 shadow-lg">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">
                        <i class="fas fa-chart-line text-secondary"></i>
                        Conversion Results
                    </h2>
                    
                    <div x-show="results.show" x-transition>
                        <!-- OME Summary -->
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <h3 class="font-bold">Total Daily OME</h3>
                                <span x-text="results.totalOme.toFixed(1)">--</span> mg morphine equivalent
                            </div>
                        </div>

                        <!-- Target Drug Result -->
                        <div class="alert alert-success mb-4">
                            <i class="fas fa-check-circle"></i>
                            <div>
                                <h3 class="font-bold">Recommended Conversion</h3>
                                <span x-text="results.targetResult">--</span>
                            </div>
                        </div>

                        <!-- Editable Table -->
                        <div class="divider">Parsed Medications (Editable)</div>
                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full">
                                <thead>
                                    <tr>
                                        <th>Drug</th>
                                        <th>Route</th>
                                        <th>Dose</th>
                                        <th>Units</th>
                                        <th>Frequency</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(med, index) in results.medications" :key="index">
                                        <tr>
                                            <td>
                                                <select x-model="med.drug" class="select select-bordered select-sm w-full">
                                                    <option value="morphine">Morphine</option>
                                                    <option value="oxycodone">Oxycodone</option>
                                                    <option value="hydromorphone">Hydromorphone</option>
                                                    <option value="fentanyl">Fentanyl</option>
                                                    <option value="methadone">Methadone</option>
                                                    <option value="buprenorphine">Buprenorphine</option>
                                                    <option value="tramadol">Tramadol</option>
                                                    <option value="codeine">Codeine</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select x-model="med.route" class="select select-bordered select-sm w-full">
                                                    <option value="po">PO</option>
                                                    <option value="iv">IV</option>
                                                    <option value="im">IM</option>
                                                    <option value="sc">SC</option>
                                                    <option value="transdermal">Transdermal</option>
                                                    <option value="buc_sublingual">Buccal/SL</option>
                                                    <option value="rectal">Rectal</option>
                                                </select>
                                            </td>
                                            <td>
                                                <input x-model="med.dose" type="number" step="0.1" class="input input-bordered input-sm w-full">
                                            </td>
                                            <td>
                                                <select x-model="med.units" class="select select-bordered select-sm w-full">
                                                    <option value="mg/day">mg/day</option>
                                                    <option value="mcg/hr">mcg/hr</option>
                                                    <option value="mcg/day">mcg/day</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select x-model="med.frequency" class="select select-bordered select-sm w-full">
                                                    <option value="">Select frequency</option>
                                                    <option value="daily">Daily / QD</option>
                                                    <option value="twice daily">Twice Daily / BID</option>
                                                    <option value="three times daily">Three Times Daily / TID</option>
                                                    <option value="four times daily">Four Times Daily / QID</option>
                                                    <option value="every 4 hours">Every 4 Hours / Q4H</option>
                                                    <option value="every 6 hours">Every 6 Hours / Q6H</option>
                                                    <option value="every 8 hours">Every 8 Hours / Q8H</option>
                                                    <option value="every 12 hours">Every 12 Hours / Q12H</option>
                                                    <option value="q4h">Q4H</option>
                                                    <option value="q6h">Q6H</option>
                                                    <option value="q8h">Q8H</option>
                                                    <option value="q12h">Q12H</option>
                                                    <option value="bid">BID</option>
                                                    <option value="tid">TID</option>
                                                    <option value="qid">QID</option>
                                                    <option value="prn">PRN / As Needed</option>
                                                </select>
                                            </td>
                                            <td>
                                                <button @click="removeMedication(index)" class="btn btn-sm btn-error">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                            <div class="mt-4 text-center">
                                <button @click="recalculate()" class="btn btn-primary btn-sm">
                                    <i class="fas fa-sync-alt"></i>
                                    Recalculate with Changes
                                </button>
                            </div>
                        </div>
                    </div>

                    <div x-show="!results.show" class="text-center py-8 text-base-content/50">
                        <i class="fas fa-flask text-4xl mb-4"></i>
                        <p>Enter a regimen above to see conversion results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function opioidConverter() {
            return {
                // Form data
                regimenText: '',
                targetDrug: 'morphine',
                targetRoute: 'po',
                loading: false,
                
                // Voice recording state
                voiceStatus: {
                    recording: false,
                    message: '',
                    error: false
                },
                
                // Results data
                results: {
                    show: false,
                    totalOme: 0,
                    targetResult: '',
                    medications: []
                },
                
                // Voice recorder
                recognition: null,
                
                init() {
                    this.initVoiceRecognition();
                },
                
                initVoiceRecognition() {
                    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                        this.recognition = new SpeechRecognition();
                        this.recognition.continuous = false;
                        this.recognition.interimResults = true;
                        this.recognition.lang = 'en-US';

                        this.recognition.onstart = () => {
                            this.voiceStatus.recording = true;
                            this.voiceStatus.message = 'Listening... Click to stop';
                            this.voiceStatus.error = false;
                        };

                        this.recognition.onresult = (event) => {
                            const transcript = Array.from(event.results)
                                .map(result => result[0])
                                .map(result => result.transcript)
                                .join('');
                            this.regimenText = transcript;
                        };

                        this.recognition.onend = () => {
                            this.voiceStatus.recording = false;
                            this.voiceStatus.message = '';
                        };

                        this.recognition.onerror = (event) => {
                            this.voiceStatus.recording = false;
                            this.voiceStatus.message = `Error: ${event.error}`;
                            this.voiceStatus.error = true;
                            setTimeout(() => {
                                this.voiceStatus.message = '';
                            }, 3000);
                        };
                    }
                },
                
                toggleVoiceRecording() {
                    if (!this.recognition) return;
                    
                    if (this.voiceStatus.recording) {
                        this.recognition.stop();
                    } else {
                        this.recognition.start();
                    }
                },
                
                async calculateConversion() {
                    if (!this.regimenText.trim()) return;
                    
                    this.loading = true;
                    
                    try {
                        // Parse the natural language
                        const parseResponse = await fetch('/parse', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: this.regimenText })
                        });

                        if (!parseResponse.ok) {
                            throw new Error('Failed to parse regimen');
                        }

                        const parseData = await parseResponse.json();

                        // Convert the parsed regimen
                        console.log('Sending to /convert:', {
                            regimen: parseData.regimen,
                            target_drug: this.targetDrug,
                            target_route: this.targetRoute
                        });
                        
                        const convertResponse = await fetch('/convert', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                regimen: parseData.regimen,
                                target_drug: this.targetDrug,
                                target_route: this.targetRoute
                            })
                        });

                        if (!convertResponse.ok) {
                            throw new Error('Failed to convert regimen');
                        }

                        const convertData = await convertResponse.json();

                        // Update results
                        this.results.show = true;
                        this.results.totalOme = convertData.total_ome;
                        this.results.targetResult = `${convertData.target_dose.toFixed(1)} ${convertData.target_units} ${convertData.target_drug} (${convertData.target_route.toUpperCase()})`;
                        console.log('Convert response:', convertData);
                        console.log('Target result:', this.results.targetResult);
                        
                        // Force array reactivity
                        this.results.medications = [];
                        this.$nextTick(() => {
                            this.results.medications = parseData.regimen.medications;
                            console.log('Medications array:', this.results.medications);
                        });

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error processing conversion: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },
                
                removeMedication(index) {
                    this.results.medications.splice(index, 1);
                    if (this.results.medications.length === 0) {
                        this.results.show = false;
                    }
                },
                
                async recalculate() {
                    this.loading = true;
                    
                    try {
                        const convertResponse = await fetch('/convert', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                regimen: { medications: this.results.medications },
                                target_drug: this.targetDrug,
                                target_route: this.targetRoute
                            })
                        });

                        if (!convertResponse.ok) {
                            throw new Error('Failed to convert regimen');
                        }

                        const convertData = await convertResponse.json();

                        this.results.totalOme = convertData.total_ome;
                        this.results.targetResult = `${convertData.target_dose.toFixed(1)} ${convertData.target_units} ${convertData.target_drug} (${convertData.target_route.toUpperCase()})`;

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error recalculating: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    </script>
</body>
</html>